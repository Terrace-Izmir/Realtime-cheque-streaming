<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dispatch Tracker — Mobile & Desktop</title>
    <style>
      :root{
        --bg:#f6f8fb; --card:#ffffff; --accent:#0b67ff; --muted:#6b7280; --success:#0ea5a4; --danger:#ef4444;
        --radius:12px; --gap:12px; --pad:14px;
      }
      html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#0f172a;background:var(--bg)}
      .app{max-width:1100px;margin:0 auto;padding:16px}
      header.appbar{display:flex;align-items:center;gap:12px;justify-content:space-between}
      .brand{display:flex;align-items:center;gap:12px}
      .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#0b67ff,#00d4ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
      h1{font-size:18px;margin:0}
      .controls{display:flex;gap:8px;align-items:center}
      .chip{background:var(--card);border-radius:999px;padding:8px 12px;border:1px solid #e6eef9;color:var(--muted);font-weight:600}

      /* filters */
      .filters{display:flex;gap:8px;margin:14px 0;flex-wrap:wrap}
      .search{flex:1;display:flex}
      .search input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6eef9}
      .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;font-weight:700}
      .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(11,103,255,0.12)}

      /* grid */
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
      .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 1px 2px rgba(8,15,32,0.04);border:1px solid #eef4ff}
      .card .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
      .orderno{font-weight:800;color:#0b67ff}
    </style>
    <script>
      // Inline fallback translations (kept for safety). We'll attempt to load external JSON files
      // from /locales/{lang}.json and merge them on startup so translators can edit files.
      const TRANSLATIONS = {
        en: {
          appTitle: 'Dispatch & Receipts',
          appSubtitle: 'Mobile-first real-time delivery tracking',
          role_driver: 'Driver',
          role_dispatcher: 'Dispatcher',
          role_accounting: 'Accounting',
          createReceipt: 'Create Receipt',
          newReturn: 'New Return',
          all: 'All',
          returns: 'Returns',
          other: 'Other',
          searchPlaceholder: 'Search (order no, name, phone)',
          filterLabel: 'Filters',
          from: 'From',
          to: 'To',
          createdRange: 'Created range',
          startRange: 'Start range',
          completeRange: 'Complete range',
          returnedRange: 'Returned range',
          startAction: 'Start',
          completeAction: 'Complete',
          returnAction: 'Return',
          print: 'Print',
          downloadPdf: 'Download PDF',
          save: 'Save',
          cancel: 'Cancel',
          close: 'Close',
          ok: 'OK',
          yes: 'Yes',
          no: 'No',
          confirmDelete: 'Are you sure you want to delete?',
          createTitle: 'Create Receipt',
          createName: 'Name',
          createPhone: 'Phone',
          createAddress: 'Address',
          createNotes: 'Notes',
          uploadPhoto: 'Upload photo',
          takePhoto: 'Take photo',
          noOrders: 'No receipts found',
          status_pending: 'Pending',
          status_in_progress: 'In Progress',
          status_completed: 'Completed',
          status_returned: 'Returned',
          savedReturn: 'Return saved',
          saveReturnFail: 'Failed to save return',
          serverUnavailable: 'Server unavailable',
          dispatchStartedToast: 'Dispatch started for %s',
          dispatchCompletedToast: 'Dispatch completed for %s',
          returnSavedToast: 'Return saved for %s',
          languagePromptTitle: 'Choose your language',
          languagePromptBody: 'Select your preferred UI language for this device.',
          detectedLanguageLabel: 'Detected: %s',
          lang_en: 'English',
          lang_tr: 'Türkçe',
          lang_ar: 'العربية',
          lang_id: 'Bahasa Indonesia',
          manageSettings: 'Settings',
          languageSaved: 'Language saved',
          languageSaveFail: 'Failed to save language',
          printHeader: 'Receipt',
          printFooter: 'Generated by Dispatch & Receipts'
        }
      };

      // Try fetch a locale JSON file from /locales/{lang}.json and return parsed object or null
      async function fetchLocale(lang) {
        try {
          const res = await fetch(`/locales/${lang}.json`);
          if (!res.ok) return null;
          const data = await res.json();
          return data;
        } catch (e) {
          console.warn('Could not fetch locale', lang, e);
          return null;
        }
      }

      // Merge src into target shallowly
      function merge(target, src) {
        for (const k in src) target[k] = src[k];
        return target;
      }

      // current language and merged dictionary
      let LANG = 'en';
      const currentLocale = {};

      // translation helper: t('key') -> string or undefined
      function t(key){
        if (!key) return '';
        // try merged locale, then inline TRANSLATIONS
        if (currentLocale && currentLocale[key]) return currentLocale[key];
        if (TRANSLATIONS[LANG] && TRANSLATIONS[LANG][key]) return TRANSLATIONS[LANG][key];
        // fallback to English inline
        if (TRANSLATIONS['en'] && TRANSLATIONS['en'][key]) return TRANSLATIONS['en'][key];
        return undefined;
      }
      
        items.forEach(o=>{
          const c = document.createElement('article'); c.className='card'; c.style.position='relative';
          const statusClass = o.status === 'created' ? 'created' : (o.status === 'in_transit' ? 'in_transit' : (o.status === 'returned' ? 'returned' : 'completed'));
          c.innerHTML = `
            <div class="meta">
              <div>
                      <div style="display:flex;gap:10px;align-items:center">
                        <div class="orderno">${o.orderNumber||('#'+o.id)}</div>
                        <div style="font-size:12px;color:var(--muted)">${o.createdAt ? new Date(o.createdAt).toLocaleString() : ''}</div>
                      </div>
                      <div class="site">${o.site && o.site.name ? (o.site.name + (o.site.address ? ' • ' + o.site.address : '')) : ''}</div>
              </div>
              <div><div class="status ${statusClass}">${t('status_' + o.status) || o.status.replace('_',' ')}</div></div>
            </div>
            <div class="items">${t('itemsLabel') || 'Items'}: ${(o.items||[]).join(', ')}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:6px">${t('createdLabel') || 'Created'}: ${o.createdAt ? new Date(o.createdAt).toLocaleString() : ''} ${o.startAt?(' • '+(t('startedLabel')||'Start')+': '+ new Date(o.startAt).toLocaleString()):''} ${o.completeAt?(' • '+(t('completedLabel')||'Complete')+': '+ new Date(o.completeAt).toLocaleString()):''}</div>
          `;

          const footer = document.createElement('div'); footer.className='footer';
          // driver actions
            if (role === 'driver'){
            if (o.status === 'created'){
              const btn = document.createElement('button'); btn.textContent=t('startAction') || 'Start'; btn.onclick = ()=> openStartModal(o); footer.appendChild(btn);
            } else if (o.status === 'in_transit'){
              const btn = document.createElement('button'); btn.textContent=t('completeAction') || 'Complete'; btn.onclick = ()=> openCompleteModal(o); footer.appendChild(btn);
            }
          }

              // add return button for relevant roles
              if (role === 'dispatcher' || role === 'driver'){
        const retBtn = document.createElement('button'); retBtn.textContent=t('returnLabel') || 'Return'; retBtn.onclick = ()=> openReturnModal(o); footer.appendChild(retBtn);
              }

          // common view details
      const det = document.createElement('button'); det.textContent=t('detail') || 'Detail'; det.onclick = ()=> openDetailModal(o); footer.appendChild(det);

          c.appendChild(footer);
          grid.appendChild(c);
        });

      // Modal helpers
      const modalBackdrop = document.getElementById('modalBackdrop');
      const modalContent = document.getElementById('modalContent');
      function openModal(html){ modalContent.innerHTML = ''; modalContent.appendChild(html); modalBackdrop.style.display='flex'; }
      function closeModal(){ modalBackdrop.style.display='none'; }
      document.getElementById('closeModal').onclick = closeModal;

      // Create form modal
      document.getElementById('btnNew').addEventListener('click', ()=>{
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <h3>Yeni Sipariş</h3>
          <div class="row"><input id="m_orderNumber" placeholder="${t('orderNumberPlaceholder') || 'Sipariş No (opsiyonel)'}" /></div>
          <div class="row"><input id="m_siteName" placeholder="${t('siteNamePlaceholder') || 'Şantiye / Proje Adı'}" /></div>
          <div class="row"><input id="m_siteAddress" placeholder="${t('siteAddressPlaceholder') || 'Şantiye Adresi'}" /></div>
          <div class="row"><input id="m_driver" placeholder="${t('driverPlaceholder') || 'Sürücü Adı / Telefon'}" /></div>
          <div class="row"><textarea id="m_items" placeholder="${t('itemsPlaceholder') || 'Ürünler, virgülle ayırın'}"></textarea></div>
          <div class="actions"><button id="createSubmit" class="btn">${t('create') || 'Oluştur'}</button><button id="createCancel" class="btn secondary">${t('cancel') || 'İptal'}</button></div>
        `;
        openModal(wrapper);
        document.getElementById('createCancel').onclick = closeModal;
    document.getElementById('createSubmit').onclick = async ()=>{
          const payload = {
            orderNumber: document.getElementById('m_orderNumber').value || undefined,
            siteName: document.getElementById('m_siteName').value,
            siteAddress: document.getElementById('m_siteAddress').value,
            driver: document.getElementById('m_driver').value,
            items: (document.getElementById('m_items').value||'').split(',').map(s=>s.trim()).filter(Boolean)
          };
          try{
            const res = await fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            const data = await res.json();
            showToast(t('orderCreatedToast') || 'Order created'); closeModal(); fetchOrders();
          }catch(e){ console.error(e); showToast('Oluşturulamadı'); }
        };
      });

      // New Return button (top-level)
      document.getElementById('btnNewReturn').addEventListener('click', ()=>{
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <h3>${t('newReturn') || 'Yeni İade'}</h3>
          <div class="row"><input id="r_orderId" placeholder="${t('orderIdPlaceholder') || 'Sipariş ID veya No'}" /></div>
          <div class="row"><textarea id="r_notes" placeholder="${t('returnNotesPlaceholder') || 'İade notları / sebep'}"></textarea></div>
          <div class="row"><label style="font-size:13px;color:var(--muted)">${t('returnPhotoLabel') || 'İade fotoğrafı (kamera)'}</label><input id="r_photo" type="file" accept="image/*" capture="environment" /></div>
          <div class="actions"><button id="r_submit" class="btn">${t('save') || 'Kaydet'}</button><button id="r_cancel" class="btn secondary">${t('cancel') || 'İptal'}</button></div>
        `;
        openModal(wrapper);
        document.getElementById('r_cancel').onclick = closeModal;
        document.getElementById('r_submit').onclick = async ()=>{
          const key = document.getElementById('r_orderId').value.trim();
          const notes = document.getElementById('r_notes').value;
          if (!key){ showToast(t('enterOrderId') || 'Enter order ID'); return; }
          // resolve ID: if starts with ORD- or contains non-numeric, try to find in state.orders
          let id = key;
          const found = state.orders.find(x=> (x.orderNumber&&x.orderNumber===key) || String(x.id)===key );
          if (found) id = found.id;
          const fileInput = document.getElementById('r_photo');
          const fd = new FormData(); fd.append('notes', JSON.stringify({ text: notes }));
          if (fileInput.files.length) fd.append('photo', fileInput.files[0], fileInput.files[0].name);
          try{
            await fetch('/api/orders/'+id+'/return', { method:'POST', body: fd });
            showToast(t('savedReturn') || 'Return saved'); closeModal(); fetchOrders();
          }catch(e){ console.error(e); showToast(t('saveReturnFail') || 'Return failed'); }
        };
      });

      // openReturnModal per-order
      function openReturnModal(o){
        const el = document.createElement('div');
        el.innerHTML = `
          <h3>${t('returnLabel') || 'Return'} — ${o.orderNumber||('#'+o.id)}</h3>
          <div class="row"><textarea id="m_return_notes" placeholder="${t('returnNotesPlaceholder') || 'Return notes / reason'}"></textarea></div>
          <div class="row"><label style="font-size:13px;color:var(--muted)">${t('returnPhotoLabel') || 'Return photo (camera)'}</label><input id="m_return_photo" type="file" accept="image/*" capture="environment" /></div>
          <div class="actions"><button id="m_return_submit" class="btn">${t('returnLabel') || 'Return'}</button><button id="m_return_cancel" class="btn secondary">${t('cancel') || 'Cancel'}</button></div>
        `;
        openModal(el);
        document.getElementById('m_return_cancel').onclick = closeModal;
        document.getElementById('m_return_submit').onclick = async ()=>{
          const notes = document.getElementById('m_return_notes').value;
          const fileInput = document.getElementById('m_return_photo');
          const fd = new FormData(); fd.append('notes', JSON.stringify({ text: notes }));
          if (fileInput.files.length) fd.append('photo', fileInput.files[0], fileInput.files[0].name);
          try{
            await fetch('/api/orders/'+o.id+'/return', { method:'POST', body: fd });
            showToast(t('savedReturn') || 'Return saved'); closeModal(); fetchOrders();
          }catch(e){ console.error(e); showToast(t('saveReturnFail') || 'Return failed'); }
        };
      }

      // Detail modal
      function openDetailModal(o){
        const el = document.createElement('div');
        el.innerHTML = `
          <h3>${t('detail') || 'Detail'} — ${o.orderNumber||('#'+o.id)}</h3>
          <div style="font-size:13px;color:var(--muted)">${o.site && o.site.name ? o.site.name + (o.site.address ? ' • '+o.site.address : '') : ''}</div>
          <div style="margin-top:8px">${t('roleLabel') || 'Driver'}: ${o.driver||''}</div>
          <div style="margin-top:8px">${t('itemsLabel') || 'Items'}: ${(o.items||[]).join(', ')}</div>
          <div style="margin-top:8px">${t('status_' + o.status) || o.status}</div>
        `;
          if (o.startPhoto){ const img = document.createElement('img'); img.src = '/uploads/'+o.startPhoto; img.style.maxWidth='100%'; img.style.marginTop='8px'; el.appendChild(img); }
        if (o.completePhoto){ const img2 = document.createElement('img'); img2.src = '/uploads/'+o.completePhoto; img2.style.maxWidth='100%'; img2.style.marginTop='8px'; el.appendChild(img2); }
    if (o.startAnswers){ const d = document.createElement('div'); d.style.marginTop='8px'; d.innerHTML = '<strong>'+ (t('startAnswersLabel') || 'Start answers') + ':</strong><br>'+Object.entries(o.startAnswers).map(e=>`${e[0]}: ${e[1]}`).join('<br>'); el.appendChild(d); }
    if (o.completeAnswers){ const d2 = document.createElement('div'); d2.style.marginTop='8px'; d2.innerHTML = '<strong>'+ (t('completeAnswersLabel') || 'Complete answers') + ':</strong><br>'+Object.entries(o.completeAnswers).map(e=>`${e[0]}: ${e[1]}`).join('<br>'); el.appendChild(d2); }
    if (o.returnedAt){ const dr = document.createElement('div'); dr.style.marginTop='8px'; dr.innerHTML = '<strong>'+ (t('returnNotesLabel') || 'Return notes') + ':</strong><br>' + (o.returnNotes && o.returnNotes.text ? o.returnNotes.text : JSON.stringify(o.returnNotes || {})); el.appendChild(dr); }

    // ribbon for returned
  if (o.returnedAt){ const r = document.createElement('div'); r.className='ribbon'; r.textContent=t('returnRibbon') || 'RETURN'; el.appendChild(r); }
  // add print button
  const printBtn = document.createElement('button'); printBtn.textContent=t('print') || 'Print'; printBtn.className='btn';
        printBtn.style.marginRight='8px';
        printBtn.onclick = ()=>{
          const w = window.open('','_blank');
          const html = `<!doctype html><html><head><meta charset="utf-8"><title>Fiş - ${o.orderNumber||('#'+o.id)}</title><style>body{font-family:Arial;padding:20px} h1{font-size:20px} .meta{margin-bottom:10px}</style></head><body>`+
            `<h1>${t('detail')} - ${o.orderNumber||('#'+o.id)}</h1>`+
            `<div class="meta">${t('siteNamePlaceholder') || 'Site'}: ${o.site && o.site.name ? o.site.name : ''} ${o.site && o.site.address ? ' - '+o.site.address : ''}</div>`+
            `<div>${t('roleLabel') || 'Driver'}: ${o.driver||''}</div>`+
            `<div>${t('itemsLabel') || 'Items'}: ${(o.items||[]).join(', ')}</div>`+
            `${o.startPhoto?('<div><img src="'+location.origin+'/uploads/'+o.startPhoto+'" style="max-width:300px;margin-top:10px"></div>') : ''}`+
            `${o.completePhoto?('<div><img src="'+location.origin+'/uploads/'+o.completePhoto+'" style="max-width:300px;margin-top:10px"></div>') : ''}`+
            `${o.returnPhoto?('<div><img src="'+location.origin+'/uploads/'+o.returnPhoto+'" style="max-width:300px;margin-top:10px"></div>') : ''}`+
            `${o.returnNotes?('<div style="margin-top:10px"><strong>İade notları:</strong><br>' + (o.returnNotes.text || JSON.stringify(o.returnNotes)) + '</div>') : ''}`+
            `<div style="margin-top:20px">${t('createdLabel') || 'Created'}: ${o.createdAt? new Date(o.createdAt).toLocaleString() : ''}</div>`+
            `</body></html>`;
          w.document.write(html); w.document.close(); w.focus(); setTimeout(()=> w.print(),500);
        };
        const btnRow = document.createElement('div'); btnRow.style.marginTop='8px'; btnRow.appendChild(printBtn);
        el.appendChild(btnRow);
        openModal(el);
      }

      // Start / Complete modals (with camera-friendly input)
      function openStartModal(o){
        const el = document.createElement('div');
        el.innerHTML = `
          <h3>${t('startAction') || 'Start'} — ${o.orderNumber||('#'+o.id)}</h3>
          <div class="row"><input id="s_plaka" placeholder="${t('platePlaceholder') || 'Vehicle plate'}" /></div>
          <div class="row"><label style="font-size:13px;color:var(--muted)">${t('photoLabel') || 'Photo (camera)'}</label><input id="s_photo" type="file" accept="image/*" capture="environment" /></div>
          <div class="actions"><button id="s_submit" class="btn">${t('startAction') || 'Start'}</button><button id="s_cancel" class="btn secondary">${t('cancel') || 'Cancel'}</button></div>
        `;
        openModal(el);
        document.getElementById('s_cancel').onclick = closeModal;
        document.getElementById('s_submit').onclick = async ()=>{
          const answers = { 'Araç plaka': document.getElementById('s_plaka').value };
          const fileInput = document.getElementById('s_photo');
          const fd = new FormData(); fd.append('answers', JSON.stringify(answers));
          if (fileInput.files.length) fd.append('photo', fileInput.files[0], fileInput.files[0].name);
          try{
            await fetch(`/api/orders/${o.id}/start`, { method:'POST', body: fd });
            showToast(t('dispatchStartedToast') || 'Dispatch started'); closeModal(); fetchOrders();
          }catch(e){ console.error(e); showToast('Başlatılamadı'); }
        };
      }

      function openCompleteModal(o){
        const el = document.createElement('div');
        el.innerHTML = `
          <h3>${t('completeAction') || 'Complete'} — ${o.orderNumber||('#'+o.id)}</h3>
          <div class="row"><input id="c_teslimeden" placeholder="${t('deliveredByPlaceholder') || 'Delivered by (name/phone)'}" /></div>
          <div class="row"><input id="c_fisno" placeholder="${t('receiptNumberPlaceholder') || 'Receipt number'}" /></div>
          <div class="row"><label style="font-size:13px;color:var(--muted)">${t('photoLabel') || 'Photo (camera)'}</label><input id="c_photo" type="file" accept="image/*" capture="environment" /></div>
          <div class="actions"><button id="c_submit" class="btn">${t('completeAction') || 'Complete'}</button><button id="c_cancel" class="btn secondary">${t('cancel') || 'Cancel'}</button></div>
        `;
        openModal(el);
        document.getElementById('c_cancel').onclick = closeModal;
        document.getElementById('c_submit').onclick = async ()=>{
          const answers = { 'Teslim eden': document.getElementById('c_teslimeden').value, 'Fiş numarası': document.getElementById('c_fisno').value };
          const fileInput = document.getElementById('c_photo');
          const fd = new FormData(); fd.append('answers', JSON.stringify(answers));
          if (fileInput.files.length) fd.append('photo', fileInput.files[0], fileInput.files[0].name);
          try{
            await fetch(`/api/orders/${o.id}/complete`, { method:'POST', body: fd });
            showToast(t('dispatchCompletedToast') || 'Dispatch completed'); closeModal(); fetchOrders();
          }catch(e){ console.error(e); showToast('Tamamlanamadı'); }
        };
      }

      // Socket events
  socket.on('order_created', data=>{ playNotify((t('orderCreatedToast')||'New order')+': '+(data.orderNumber||data.id)); fetchOrders(); });
  socket.on('dispatch_started', data=>{ playNotify((t('dispatchStartedToast')||'Dispatch started')+': '+(data.orderNumber||data.id)); fetchOrders(); });
  socket.on('dispatch_completed', data=>{ playNotify((t('dispatchCompletedToast')||'Dispatch completed')+': '+(data.orderNumber||data.id)); fetchOrders(); });

      function playNotify(text){ try{ if (Notification && Notification.permission !== 'granted') Notification.requestPermission(); if (Notification && Notification.permission === 'granted') new Notification(text); }catch(e){} try{ ping.play(); }catch(e){} showToast(text); }

      // role change
      document.getElementById('changeRole').addEventListener('click', ()=>{
        const r = prompt(t('rolePrompt') || 'Enter your role: driver / dispatcher / accounting', role)||role; role = r; localStorage.setItem('role', role); document.getElementById('roleLabel').textContent = role; socket.emit('join', role === 'driver' ? 'drivers' : role); showToast((t('roleChanged')||'Role: {role}').replace('{role}', role)); fetchOrders();
      });

  document.getElementById('btnRefresh').addEventListener('click', ()=> fetchOrders(qEl.value.trim()));
  document.getElementById('btnRefresh').textContent = t('btnRefresh') || document.getElementById('btnRefresh').textContent;
  qEl.addEventListener('input', render);
  statusFilter.addEventListener('change', render);

      // init
      (async function loadLangAndInit(){
        try{
          const res = await fetch('/api/settings/language');
          const body = await res.json();
          if (body && body.value){
            LANG = body.value;
            const remote = await fetchLocale(LANG);
            if (remote) merge(currentLocale, remote);
            applyTranslations(); fetchOrders();
          }
          else {
            // auto-detect from browser
            const nav = (navigator.language || navigator.userLanguage || 'en').slice(0,2).toLowerCase();
            const map = { tr: 'tr', en: 'en', ar: 'ar', id: 'id', in: 'id' };
            const detected = map[nav] || 'en';
            LANG = detected;
            try{ await fetch('/api/settings/language', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ value: detected }) }); }catch(e){}
            try{ const remote = await fetchLocale(LANG); if (remote) merge(currentLocale, remote); }catch(e){}
            applyTranslations(); fetchOrders();
            showToast((t('detectedLanguageLabel') || 'Language auto-set to') + ' ' + LANG.toUpperCase());
          }
        }catch(e){ console.error(e); // fallback: use browser locale
          const nav = (navigator.language || navigator.userLanguage || 'en').slice(0,2).toLowerCase();
          const map = { tr: 'tr', en: 'en', ar: 'ar', id: 'id', in: 'id' };
          LANG = map[nav] || 'en'; applyTranslations(); fetchOrders();
        }
      })();

      function applyTranslations(){
        // update a handful of labels
        document.getElementById('btnNew').textContent = t('newOrder');
        document.getElementById('btnNewReturn').textContent = t('newReturn');
        document.getElementById('tabReturns').textContent = t('returns');
        document.getElementById('tabAll').textContent = t('all');
        document.getElementById('tabOther').textContent = t('other');
  document.getElementById('changeLang').textContent = t('selectLanguage') || 'Select language';
        // update placeholders and buttons broadly where possible
        document.getElementById('q').placeholder = t('searchPlaceholder') || document.getElementById('q').placeholder;
        // role label
        document.getElementById('roleChip').innerHTML = t('roleLabel') + ': <strong id="roleLabel">'+ (localStorage.getItem('role')||'driver') +'</strong>';
        // header title/subtitle
        try{ document.querySelector('.brand h1').textContent = t('appTitle') || document.querySelector('.brand h1').textContent; document.querySelector('.brand div[style]').textContent = t('appSubtitle') || document.querySelector('.brand div[style]').textContent; }catch(e){}
        // modal close
        try{ document.getElementById('closeModal').textContent = t('modalClose') || document.getElementById('closeModal').textContent; }catch(e){}
        // tabs and filters
        try{ document.getElementById('lblCreatedRange').textContent = t('createdRange') || document.getElementById('lblCreatedRange').textContent; document.getElementById('lblStartRange').textContent = t('startRange') || document.getElementById('lblStartRange').textContent; document.getElementById('lblCompleteRange').textContent = t('completeRange') || document.getElementById('lblCompleteRange').textContent; document.getElementById('lblReturnedRange').textContent = t('returnedRange') || document.getElementById('lblReturnedRange').textContent; }catch(e){}
        try{ document.getElementById('opt_all').textContent = t('status_all') || document.getElementById('opt_all').textContent; document.getElementById('opt_created').textContent = t('status_created') || document.getElementById('opt_created').textContent; document.getElementById('opt_in_transit').textContent = t('status_in_transit') || document.getElementById('opt_in_transit').textContent; document.getElementById('opt_completed').textContent = t('status_completed') || document.getElementById('opt_completed').textContent; }catch(e){}
        try{ document.getElementById('btnRefresh').textContent = t('btnRefresh') || document.getElementById('btnRefresh').textContent; }catch(e){}
        // set page lang attribute
        try{ document.documentElement.lang = LANG; }catch(e){}
        // set RTL for Arabic
        if (LANG === 'ar'){
          document.documentElement.dir = 'rtl';
          document.body.style.textAlign = 'right';
        } else {
          document.documentElement.dir = 'ltr';
          document.body.style.textAlign = '';
        }
      }

      function openLangModal(){
        const w = document.createElement('div');
        w.innerHTML = `
          <h3>${t('selectLanguageTitle') || 'Dil seç / Choose language'}</h3>
          <div class="row"><select id="langSel"><option value="tr">Türkçe</option><option value="en">English</option><option value="ar">العربية</option><option value="id">Bahasa Indonesia</option></select></div>
          <div class="actions"><button id="langSave" class="btn">${t('save') || 'Kaydet'}</button></div>
        `;
        openModal(w);
        document.getElementById('langSave').onclick = async ()=>{
          const sel = document.getElementById('langSel').value;
          LANG = sel;
          try{ await fetch('/api/settings/language', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ value: sel }) }); }catch(e){ console.error(e); }
          applyTranslations(); closeModal(); fetchOrders();
        };
      }

      document.getElementById('changeLang').addEventListener('click', ()=> openLangModal());
    </script>
  </body>
</html>
